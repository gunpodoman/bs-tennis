import React, { useState, useEffect, useRef } from 'react';
import { Sword, Hammer, Sparkles, Skull, Coins, Zap, Trophy, RefreshCcw } from 'lucide-react';

// --- 게임 데이터 및 설정 ---
const SWORD_TIERS = [
  { level: 0, name: "나뭇가지", color: "text-amber-800", shadow: "shadow-amber-900", rate: 100, cost: 10, value: 5 },
  { level: 1, name: "녹슨 단검", color: "text-stone-500", shadow: "shadow-stone-600", rate: 90, cost: 50, value: 25 },
  { level: 2, name: "수습 기사의 검", color: "text-slate-400", shadow: "shadow-slate-500", rate: 80, cost: 150, value: 75 },
  { level: 3, name: "정교한 강철검", color: "text-slate-200", shadow: "shadow-slate-300", rate: 75, cost: 300, value: 150 },
  { level: 4, name: "푸른 서슬의 검", color: "text-blue-400", shadow: "shadow-blue-500", rate: 70, cost: 600, value: 300 },
  { level: 5, name: "타오르는 붉은 검", color: "text-red-500", shadow: "shadow-red-600", rate: 60, cost: 1000, value: 500 },
  { level: 6, name: "황금 사자 검", color: "text-yellow-400", shadow: "shadow-yellow-500", rate: 50, cost: 2000, value: 1000 },
  { level: 7, name: "에메랄드 드래곤", color: "text-emerald-400", shadow: "shadow-emerald-500", rate: 40, cost: 4000, value: 2000 },
  { level: 8, name: "심연의 흑요석", color: "text-purple-500", shadow: "shadow-purple-600", rate: 30, cost: 8000, value: 4000 },
  { level: 9, name: "천상의 빛", color: "text-cyan-300", shadow: "shadow-cyan-400", rate: 20, cost: 15000, value: 7500 },
  { level: 10, name: "신 살해자 (God Slayer)", color: "text-rose-500", shadow: "shadow-rose-600", rate: 10, cost: 30000, value: 15000 },
  { level: 11, name: "우주 파괴자 (Cosmic)", color: "text-fuchsia-500", shadow: "shadow-fuchsia-600", rate: 5, cost: 100000, value: 50000 },
  { level: 12, name: "개발자의 실수 (ERROR)", color: "text-white", shadow: "shadow-white", rate: 1, cost: 999999, value: 999999 },
];

export default function App() {
  const [level, setLevel] = useState(0);
  const [gold, setGold] = useState(100);
  const [isEnhancing, setIsEnhancing] = useState(false);
  const [logs, setLogs] = useState([{ text: "검 강화 게임에 오신 것을 환영합니다!", type: "info" }]);
  const [shake, setShake] = useState(false);
  const [flash, setFlash] = useState(""); // 'success' or 'fail'
  const logEndRef = useRef(null);

  const currentTier = SWORD_TIERS[level];
  const nextTier = SWORD_TIERS[level + 1];

  // 로그 자동 스크롤
  useEffect(() => {
    logEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [logs]);

  // 로그 추가 함수
  const addLog = (text, type = "info") => {
    setLogs(prev => [...prev.slice(-19), { text, type }]); // 최근 20개만 유지
  };

  // 골드 획득 (사냥)
  const handleHunt = () => {
    const earn = Math.floor(currentTier.value * (1 + Math.random() * 0.5));
    setGold(prev => prev + earn);
    
    // 클릭 효과 (간단한 파티클 대신 텍스트 효과로 대체 가능하지만 여기선 생략)
  };

  // 강화 시도
  const handleEnhance = () => {
    if (isEnhancing) return;
    if (!nextTier) {
      addLog("이미 최고 레벨입니다!", "info");
      return;
    }
    if (gold < nextTier.cost) {
      addLog("골드가 부족합니다! 사냥을 떠나세요.", "error");
      setShake(true);
      setTimeout(() => setShake(false), 500);
      return;
    }

    setGold(prev => prev - nextTier.cost);
    setIsEnhancing(true);

    // 강화 연출 (딜레이)
    setTimeout(() => {
      const success = Math.random() * 100 < nextTier.rate;
      
      if (success) {
        // 성공
        setLevel(prev => prev + 1);
        addLog(`[성공] ${nextTier.name} (+${level + 1}) 강화 성공!`, "success");
        setFlash("success");
      } else {
        // 실패 로직
        setFlash("fail");
        // 레벨 5 이하는 유지, 6~9는 하락, 10 이상은 파괴(0으로 초기화)
        if (level < 5) {
          addLog(`[실패] 강화에 실패했지만 검은 무사합니다.`, "warning");
        } else if (level < 10) {
          addLog(`[실패] 강화 실패! 검의 등급이 하락했습니다.`, "error");
          setLevel(prev => prev - 1);
        } else {
          addLog(`[파괴] 콰창!! 검이 산산조각 났습니다. (초기화)`, "destroy");
          setLevel(0);
        }
      }

      setIsEnhancing(false);
      setTimeout(() => setFlash(""), 500);
    }, 1200); // 1.2초 긴장감
  };

  // 리셋
  const handleReset = () => {
    if(window.confirm("모든 진행상황을 초기화 하시겠습니까?")) {
      setLevel(0);
      setGold(100);
      setLogs([{ text: "새로운 게임이 시작되었습니다.", type: "info" }]);
    }
  };

  return (
    <div className={`min-h-screen bg-gray-900 text-white font-sans overflow-hidden flex flex-col items-center justify-center relative selection:bg-purple-500 selection:text-white`}>
      
      {/* 배경 효과 */}
      <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-gray-800 via-gray-900 to-black -z-10"></div>
      
      {/* 상태바 */}
      <div className="absolute top-0 w-full p-4 flex justify-between items-center bg-black/30 backdrop-blur-sm border-b border-white/10 z-20">
        <div className="flex items-center gap-2 text-yellow-400 font-bold text-xl">
          <Coins className="w-6 h-6 animate-pulse" />
          <span>{gold.toLocaleString()} G</span>
        </div>
        <button onClick={handleReset} className="text-gray-500 hover:text-white transition-colors">
          <RefreshCcw size={20} />
        </button>
      </div>

      {/* 메인 게임 영역 */}
      <div className="relative w-full max-w-md flex flex-col items-center gap-8 z-10 px-4">
        
        {/* 타이틀 */}
        <div className="text-center space-y-2">
          <h1 className="text-4xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 drop-shadow-[0_0_10px_rgba(168,85,247,0.5)]">
            SWORD ASCENSION
          </h1>
          <p className="text-gray-400 text-xs tracking-widest uppercase">Forge Your Destiny</p>
        </div>

        {/* 검 디스플레이 영역 */}
        <div className={`relative group w-64 h-80 flex items-center justify-center transition-all duration-300 ${shake ? 'animate-shake' : ''}`}>
           {/* 아우라 효과 */}
           <div className={`absolute inset-0 rounded-full blur-3xl opacity-20 transition-colors duration-1000 ${currentTier.color.replace('text-', 'bg-')}`}></div>
           
           {/* 검 아이콘 */}
           <div className={`relative transition-all duration-500 transform ${isEnhancing ? 'scale-110 animate-bounce' : 'hover:scale-105'} ${flash === 'success' ? 'scale-125 brightness-150' : ''} ${flash === 'fail' ? 'scale-90 opacity-50 grayscale' : ''}`}>
              <Sword 
                strokeWidth={1}
                className={`w-64 h-64 drop-shadow-2xl transition-all duration-500 ${currentTier.color} ${level >= 10 ? 'animate-pulse' : ''}`} 
                style={{ 
                  filter: `drop-shadow(0 0 ${level * 3}px currentColor)` 
                }}
              />
              
              {/* 강화 중 파티클 (간소화) */}
              {isEnhancing && (
                <div className="absolute inset-0 flex items-center justify-center">
                  <Sparkles className="w-full h-full text-white animate-spin-slow opacity-50" />
                </div>
              )}
           </div>

           {/* 검 이름 및 레벨 */}
           <div className="absolute -bottom-8 w-full text-center">
             <div className={`text-2xl font-black tracking-wide ${currentTier.color} drop-shadow-md`}>
               +{level} {currentTier.name}
             </div>
             <div className="text-xs text-gray-500 mt-1">가치: {currentTier.value.toLocaleString()} G</div>
           </div>
        </div>

        {/* 컨트롤 패널 */}
        <div className="w-full bg-gray-800/50 backdrop-blur-md rounded-2xl border border-white/10 p-6 space-y-4 shadow-2xl mt-8">
          
          {/* 강화 정보 */}
          {nextTier ? (
            <div className="flex justify-between items-center text-sm mb-2 px-2">
              <div className="flex flex-col">
                <span className="text-gray-400">성공 확률</span>
                <span className={`font-bold text-lg ${nextTier.rate < 30 ? 'text-red-400' : 'text-green-400'}`}>
                  {nextTier.rate}%
                </span>
              </div>
              <div className="flex flex-col items-end">
                <span className="text-gray-400">강화 비용</span>
                <span className={`font-bold text-lg ${gold >= nextTier.cost ? 'text-yellow-400' : 'text-red-500'}`}>
                  {nextTier.cost.toLocaleString()} G
                </span>
              </div>
            </div>
          ) : (
             <div className="text-center text-yellow-400 font-bold py-2">전설의 끝에 도달했습니다!</div>
          )}

          {/* 버튼 그룹 */}
          <div className="grid grid-cols-2 gap-3">
            <button
              onClick={handleHunt}
              disabled={isEnhancing}
              className="group relative overflow-hidden bg-gradient-to-br from-slate-700 to-slate-800 p-4 rounded-xl border border-slate-600 hover:border-slate-400 transition-all active:scale-95 disabled:opacity-50"
            >
              <div className="relative z-10 flex flex-col items-center gap-1">
                <Skull className="w-6 h-6 text-gray-300 group-hover:text-red-400 transition-colors" />
                <span className="font-bold text-gray-200">몬스터 사냥</span>
                <span className="text-xs text-gray-500">+{Math.floor(currentTier.value)}~ G</span>
              </div>
              <div className="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
            </button>

            <button
              onClick={handleEnhance}
              disabled={isEnhancing || !nextTier}
              className={`group relative overflow-hidden p-4 rounded-xl border transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed
                ${!nextTier ? 'bg-gray-800 border-gray-700' : 'bg-gradient-to-br from-indigo-600 to-purple-700 border-indigo-500 hover:shadow-[0_0_20px_rgba(99,102,241,0.5)]'}
              `}
            >
               {/* 로딩 바 */}
               {isEnhancing && (
                 <div className="absolute inset-0 bg-black/20 z-0">
                   <div className="h-full bg-white/20 animate-progress origin-left"></div>
                 </div>
               )}

              <div className="relative z-10 flex flex-col items-center gap-1">
                {isEnhancing ? (
                  <RefreshCcw className="w-6 h-6 text-white animate-spin" />
                ) : (
                  <Hammer className="w-6 h-6 text-indigo-200 group-hover:text-white transition-colors" />
                )}
                <span className="font-bold text-white">
                  {isEnhancing ? "강화 중..." : "강화 하기"}
                </span>
                <span className="text-xs text-indigo-200 group-hover:text-white">
                  {nextTier ? `다음: ${nextTier.name}` : "MAX LEVEL"}
                </span>
              </div>
            </button>
          </div>
        </div>

        {/* 로그 창 */}
        <div className="w-full h-32 bg-black/40 rounded-xl border border-white/5 p-3 overflow-y-auto font-mono text-xs space-y-1 shadow-inner scrollbar-hide">
          {logs.map((log, i) => (
            <div key={i} className={`
              ${log.type === 'success' ? 'text-green-400' : ''}
              ${log.type === 'fail' ? 'text-orange-400' : ''}
              ${log.type === 'destroy' ? 'text-red-500 font-bold' : ''}
              ${log.type === 'error' ? 'text-red-300' : ''}
              ${log.type === 'warning' ? 'text-yellow-300' : ''}
              ${log.type === 'info' ? 'text-gray-400' : ''}
            `}>
              {i > 0 && <span className="text-gray-700 mr-2">[{i}]</span>}
              {log.text}
            </div>
          ))}
          <div ref={logEndRef} />
        </div>

      </div>

      {/* 전체 화면 효과 (플래시) */}
      <div className={`absolute inset-0 pointer-events-none transition-opacity duration-300 ${flash === 'success' ? 'bg-white opacity-30' : flash === 'fail' ? 'bg-red-900 opacity-30' : 'opacity-0'}`}></div>

      {/* 애니메이션 스타일 정의 */}
      <style>{`
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-5px) rotate(-5deg); }
          75% { transform: translateX(5px) rotate(5deg); }
        }
        .animate-shake {
          animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes progress {
          0% { width: 0%; }
          100% { width: 100%; }
        }
        .animate-progress {
          animation: progress 1.2s linear forwards;
        }
        .animate-spin-slow {
          animation: spin 3s linear infinite;
        }
      `}</style>
    </div>
  );
}
